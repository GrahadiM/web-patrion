<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrion Team Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <!-- Game Container -->
    <div id="gameContainer" class="min-h-screen p-4 max-w-4xl mx-auto">
        
        <!-- Header Stats -->
        <div class="header-stats bg-gray-800 rounded-lg p-4 mb-6 flex justify-between items-center">
            <div class="level-info">
                <h2 class="text-2xl font-bold">Level <span id="currentLevel">1</span>/50</h2>
                <div class="text-sm text-gray-300">Team Size: <span id="teamSize">1</span>/5</div>
            </div>
            <div class="lives-info flex items-center space-x-2">
                <span class="text-lg">Nyawa:</span>
                <div class="flex space-x-1">
                    <div class="w-6 h-6 bg-red-500 rounded-full"></div>
                    <div class="w-6 h-6 bg-red-500 rounded-full"></div>
                    <div class="w-6 h-6 bg-red-500 rounded-full"></div>
                </div>
            </div>
            <div class="score-info">
                <div class="text-lg">Progress: <span id="progressPercent">2%</span></div>
            </div>
        </div>

        <!-- Character Selection -->
        <div id="characterSelection" class="selection-section mb-8">
            <h3 class="text-xl font-bold mb-4">Pilih Tim Anda</h3>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <!-- Character Cards akan di-generate oleh JavaScript -->
            </div>
            <div class="selected-team mb-4">
                <h4 class="text-lg mb-2">Tim Terpilih:</h4>
                <div id="selectedTeam" class="flex space-x-4 min-h-20 bg-gray-800 p-4 rounded-lg"></div>
            </div>
            <button id="startBattle" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold disabled:bg-gray-600 disabled:cursor-not-allowed">
                Mulai Pertarungan
            </button>
        </div>

        <!-- Battle Arena -->
        <div id="battleArena" class="battle-section hidden">
            <div class="battle-layout flex justify-between items-center mb-8">
                <!-- Player Team -->
                <div class="player-team w-2/5">
                    <h4 class="text-center mb-4 font-bold">TIM ANDA</h4>
                    <div id="playerTeamBattle" class="space-y-4"></div>
                </div>
                
                <!-- VS Indicator -->
                <div class="vs-indicator bg-red-600 w-16 h-16 rounded-full flex items-center justify-center font-bold text-xl">
                    VS
                </div>
                
                <!-- Enemy Team -->
                <div class="enemy-team w-2/5">
                    <h4 class="text-center mb-4 font-bold">MUSUH</h4>
                    <div id="enemyTeamBattle" class="space-y-4"></div>
                </div>
            </div>

            <!-- Battle Log -->
            <div id="battleLog" class="bg-gray-800 h-32 overflow-y-auto p-4 rounded-lg mb-4"></div>
            
            <!-- Battle Controls -->
            <div class="battle-controls flex justify-center space-x-4">
                <button id="attackBtn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold">
                    Serang!
                </button>
                <button id="specialBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold disabled:bg-gray-600">
                    Ability Spesial
                </button>
                <button id="fleeBtn" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg font-bold">
                    Mundur
                </button>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
            <div class="bg-gray-800 p-8 rounded-lg max-w-md text-center">
                <h3 id="resultTitle" class="text-2xl font-bold mb-4"></h3>
                <p id="resultMessage" class="mb-4"></p>
                <div id="voucherReward" class="hidden bg-yellow-500 text-yellow-900 p-4 rounded-lg mb-4">
                    <strong>Voucher Rp.10.000!</strong><br>
                    Kode: PATRION-WIN-<span id="voucherCode"></span>
                </div>
                <button id="modalButton" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg"></button>
            </div>
        </div>
    </div>

    <script>
        // GAME DATA & CONFIGURATION
        const gameConfig = {
            totalLevels: 50,
            maxLives: 3,
            maxTeamSize: 5,
            teamSizePerTier: {
                1: 1,   // Level 1-10
                2: 2,   // Level 11-20  
                3: 3,   // Level 21-30
                4: 4,   // Level 31-40
                5: 5    // Level 41-50
            }
        };

        // CHARACTER DATA - 8 karakter Patrion
        const characters = [
            { id: 1, name: "Patrion Warrior", hp: 100, attack: 15, defense: 10, special: "crush", element: "fire" },
            { id: 2, name: "Patrion Mage", hp: 80, attack: 20, defense: 5, special: "fireball", element: "fire" },
            { id: 3, name: "Patrion Archer", hp: 90, attack: 18, defense: 7, special: "snipe", element: "wind" },
            { id: 4, name: "Patrion Healer", hp: 70, attack: 10, defense: 8, special: "heal", element: "light" },
            { id: 5, name: "Patrion Tank", hp: 120, attack: 12, defense: 15, special: "shield", element: "earth" },
            { id: 6, name: "Patrion Rogue", hp: 85, attack: 22, defense: 6, special: "backstab", element: "dark" },
            { id: 7, name: "Patrion Knight", hp: 110, attack: 16, defense: 12, special: "charge", element: "light" },
            { id: 8, name: "Patrion Summoner", hp: 75, attack: 19, defense: 9, special: "summon", element: "dark" }
        ];

        // GAME STATE
        let gameState = {
            currentLevel: 1,
            currentLives: 3,
            selectedCharacters: [],
            battleInProgress: false,
            playerTeam: [],
            enemyTeam: []
        };

        // ELEMENT SYSTEM (Rock-Paper-Scissors)
        const elementAdvantage = {
            fire: { strong: "wind", weak: "water" },
            water: { strong: "fire", weak: "earth" },
            earth: { strong: "water", weak: "wind" },
            wind: { strong: "earth", weak: "fire" },
            light: { strong: "dark", weak: "dark" },
            dark: { strong: "light", weak: "light" }
        };

        // INITIALIZE GAME
        function initGame() {
            renderCharacterSelection();
            updateUI();
            loadGameProgress();
        }

        // RENDER CHARACTER SELECTION
        function renderCharacterSelection() {
            const container = document.querySelector('.grid.grid-cols-4');
            container.innerHTML = '';
            
            characters.forEach(char => {
                const charCard = document.createElement('div');
                charCard.className = `character-card bg-gray-700 p-4 rounded-lg cursor-pointer hover:scale-105 transition transform ${
                    gameState.selectedCharacters.includes(char.id) ? 'border-2 border-green-500' : ''
                }`;
                charCard.innerHTML = `
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-500 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold">
                            ${char.name.split(' ')[1][0]}
                        </div>
                        <div class="font-bold">${char.name}</div>
                        <div class="text-sm text-gray-300">HP: ${char.hp} | ATK: ${char.attack}</div>
                        <div class="text-xs text-${getElementColor(char.element)}-400">${char.element.toUpperCase()}</div>
                    </div>
                `;
                charCard.onclick = () => toggleCharacterSelection(char.id);
                container.appendChild(charCard);
            });
        }

        function getElementColor(element) {
            const colors = { fire: 'red', water: 'blue', earth: 'green', wind: 'teal', light: 'yellow', dark: 'purple' };
            return colors[element] || 'gray';
        }

        // TOGGLE CHARACTER SELECTION
        function toggleCharacterSelection(charId) {
            const maxTeamSize = getCurrentMaxTeamSize();
            
            if (gameState.selectedCharacters.includes(charId)) {
                gameState.selectedCharacters = gameState.selectedCharacters.filter(id => id !== charId);
            } else {
                if (gameState.selectedCharacters.length < maxTeamSize) {
                    gameState.selectedCharacters.push(charId);
                }
            }
            renderCharacterSelection();
            renderSelectedTeam();
            updateStartButton();
        }

        // GET CURRENT MAX TEAM SIZE BASED ON LEVEL
        function getCurrentMaxTeamSize() {
            const tier = Math.min(Math.ceil(gameState.currentLevel / 10), 5);
            return gameConfig.teamSizePerTier[tier];
        }

        // RENDER SELECTED TEAM
        function renderSelectedTeam() {
            const container = document.getElementById('selectedTeam');
            container.innerHTML = '';
            
            gameState.selectedCharacters.forEach(charId => {
                const char = characters.find(c => c.id === charId);
                const teamMember = document.createElement('div');
                teamMember.className = 'text-center';
                teamMember.innerHTML = `
                    <div class="w-12 h-12 bg-blue-500 rounded-full mx-auto mb-1 flex items-center justify-center text-white font-bold text-sm">
                        ${char.name.split(' ')[1][0]}
                    </div>
                    <div class="text-xs">${char.name.split(' ')[1]}</div>
                `;
                container.appendChild(teamMember);
            });
        }

        // UPDATE START BATTLE BUTTON
        function updateStartButton() {
            const button = document.getElementById('startBattle');
            const minTeamSize = 1;
            button.disabled = gameState.selectedCharacters.length < minTeamSize;
        }

        // UPDATE UI
        function updateUI() {
            document.getElementById('currentLevel').textContent = gameState.currentLevel;
            document.getElementById('teamSize').textContent = `${gameState.selectedCharacters.length}/${getCurrentMaxTeamSize()}`;
            document.getElementById('progressPercent').textContent = `${Math.round((gameState.currentLevel / gameConfig.totalLevels) * 100)}%`;
            
            // Update lives display
            const livesContainer = document.querySelector('.lives-info .flex');
            livesContainer.innerHTML = '';
            for (let i = 0; i < gameConfig.maxLives; i++) {
                const life = document.createElement('div');
                life.className = `w-6 h-6 rounded-full ${i < gameState.currentLives ? 'bg-red-500' : 'bg-gray-600'}`;
                livesContainer.appendChild(life);
            }
        }

        // START BATTLE
        document.getElementById('startBattle').onclick = function() {
            if (gameState.selectedCharacters.length === 0) return;
            
            gameState.playerTeam = gameState.selectedCharacters.map(charId => {
                const char = characters.find(c => c.id === charId);
                return { ...char, currentHp: char.hp };
            });
            
            generateEnemyTeam();
            startBattle();
        };

        // GENERATE ENEMY TEAM BASED ON LEVEL
        function generateEnemyTeam() {
            const enemyCount = Math.min(Math.ceil(gameState.currentLevel / 10), 5);
            const powerMultiplier = 1 + (gameState.currentLevel * 0.05); // Scale difficulty
            
            gameState.enemyTeam = [];
            
            for (let i = 0; i < enemyCount; i++) {
                const baseChar = characters[Math.floor(Math.random() * characters.length)];
                const enemy = {
                    ...baseChar,
                    id: 100 + i, // Unique enemy ID
                    name: `Enemy ${baseChar.name}`,
                    hp: Math.floor(baseChar.hp * powerMultiplier),
                    attack: Math.floor(baseChar.attack * powerMultiplier),
                    defense: Math.floor(baseChar.defense * powerMultiplier),
                    currentHp: Math.floor(baseChar.hp * powerMultiplier)
                };
                gameState.enemyTeam.push(enemy);
            }
        }

        // START BATTLE SEQUENCE
        function startBattle() {
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('battleArena').classList.remove('hidden');
            
            gameState.battleInProgress = true;
            renderBattleTeams();
            addToBattleLog("Pertarungan dimulai!");
        }

        // RENDER BATTLE TEAMS
        function renderBattleTeams() {
            renderTeam('playerTeamBattle', gameState.playerTeam, true);
            renderTeam('enemyTeamBattle', gameState.enemyTeam, false);
        }

        function renderTeam(containerId, team, isPlayer) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            team.forEach((char, index) => {
                const hpPercent = (char.currentHp / char.hp) * 100;
                const charElement = document.createElement('div');
                charElement.className = `character-battle bg-${isPlayer ? 'blue' : 'red'}-600 p-3 rounded-lg`;
                charElement.innerHTML = `
                    <div class="text-center">
                        <div class="w-12 h-12 bg-${getElementColor(char.element)}-500 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold text-sm">
                            ${char.name.split(' ')[isPlayer ? 1 : 0][0]}
                        </div>
                        <div class="font-bold text-sm">${char.name}</div>
                        <div class="health-bar bg-gray-300 h-2 mt-1 rounded">
                            <div class="health-fill bg-green-500 h-2 rounded" style="width: ${hpPercent}%"></div>
                        </div>
                        <div class="text-xs mt-1">HP: ${char.currentHp}/${char.hp}</div>
                    </div>
                `;
                container.appendChild(charElement);
            });
        }

        // BATTLE ACTIONS
        document.getElementById('attackBtn').onclick = function() {
            if (!gameState.battleInProgress) return;
            executePlayerTurn('attack');
        };

        document.getElementById('specialBtn').onclick = function() {
            if (!gameState.battleInProgress) return;
            executePlayerTurn('special');
        };

        document.getElementById('fleeBtn').onclick = function() {
            showResultModal('escape', 'Anda memilih mundur!');
        };

        // EXECUTE PLAYER TURN
        function executePlayerTurn(action) {
            // Simple battle logic - player attacks first, then enemy
            let battleLog = [];
            
            // Player attacks
            gameState.playerTeam.forEach(playerChar => {
                if (playerChar.currentHp > 0) {
                    const target = getRandomAliveEnemy();
                    if (target) {
                        const damage = calculateDamage(playerChar, target, action);
                        target.currentHp = Math.max(0, target.currentHp - damage);
                        battleLog.push(`${playerChar.name} ${action === 'special' ? 'menggunakan' : 'menyerang'} ${target.name} untuk ${damage} damage!`);
                    }
                }
            });
            
            // Check if enemies are defeated
            if (isEnemyTeamDefeated()) {
                endBattle('win');
                return;
            }
            
            // Enemy attacks
            gameState.enemyTeam.forEach(enemyChar => {
                if (enemyChar.currentHp > 0) {
                    const target = getRandomAlivePlayer();
                    if (target) {
                        const damage = calculateDamage(enemyChar, target, 'attack');
                        target.currentHp = Math.max(0, target.currentHp - damage);
                        battleLog.push(`${enemyChar.name} menyerang ${target.name} untuk ${damage} damage!`);
                    }
                }
            });
            
            // Check if player team is defeated
            if (isPlayerTeamDefeated()) {
                endBattle('lose');
                return;
            }
            
            // Update battle log and render
            battleLog.forEach(log => addToBattleLog(log));
            renderBattleTeams();
        }

        // BATTLE CALCULATIONS
        function calculateDamage(attacker, defender, action) {
            let baseDamage = action === 'special' ? attacker.attack * 1.5 : attacker.attack;
            
            // Element advantage
            const advantage = elementAdvantage[attacker.element];
            if (advantage.strong === defender.element) {
                baseDamage *= 1.5; // 50% bonus
            } else if (advantage.weak === defender.element) {
                baseDamage *= 0.5; // 50% reduction
            }
            
            const finalDamage = Math.max(1, Math.floor(baseDamage - (defender.defense * 0.3)));
            return finalDamage;
        }

        function getRandomAliveEnemy() {
            const aliveEnemies = gameState.enemyTeam.filter(enemy => enemy.currentHp > 0);
            return aliveEnemies[Math.floor(Math.random() * aliveEnemies.length)];
        }

        function getRandomAlivePlayer() {
            const alivePlayers = gameState.playerTeam.filter(player => player.currentHp > 0);
            return alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
        }

        function isEnemyTeamDefeated() {
            return gameState.enemyTeam.every(enemy => enemy.currentHp <= 0);
        }

        function isPlayerTeamDefeated() {
            return gameState.playerTeam.every(player => player.currentHp <= 0);
        }

        // BATTLE LOG
        function addToBattleLog(message) {
            const log = document.getElementById('battleLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-sm mb-1';
            logEntry.textContent = `â†’ ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // END BATTLE
        function endBattle(result) {
            gameState.battleInProgress = false;
            
            if (result === 'win') {
                handleBattleWin();
            } else {
                handleBattleLoss();
            }
        }

        function handleBattleWin() {
            addToBattleLog("ðŸŽ‰ Selamat! Anda memenangkan pertarungan!");
            
            if (gameState.currentLevel === gameConfig.totalLevels) {
                // Final victory
                showResultModal('victory', 'Selamat! Anda telah menyelesaikan semua level!');
            } else {
                gameState.currentLevel++;
                saveGameProgress();
                setTimeout(() => {
                    showResultModal('levelup', `Level ${gameState.currentLevel} terbuka!`);
                }, 1500);
            }
        }

        function handleBattleLoss() {
            gameState.currentLives--;
            addToBattleLog("ðŸ’” Tim Anda kalah! Nyawa tersisa: " + gameState.currentLives);
            
            if (gameState.currentLives <= 0) {
                setTimeout(() => {
                    showResultModal('gameover', 'Game Over! Tidak ada nyawa tersisa.');
                }, 1500);
            } else {
                setTimeout(() => {
                    showResultModal('retry', `Anda kalah! Masih ada ${gameState.currentLives} nyawa tersisa.`);
                }, 1500);
            }
        }

        // RESULT MODAL
        function showResultModal(type, message) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const messageEl = document.getElementById('resultMessage');
            const button = document.getElementById('modalButton');
            const voucher = document.getElementById('voucherReward');
            
            voucher.classList.add('hidden');
            
            switch(type) {
                case 'victory':
                    title.textContent = "KEMENANGAN BESAR!";
                    messageEl.textContent = message;
                    button.textContent = "Klaim Hadiah";
                    voucher.classList.remove('hidden');
                    document.getElementById('voucherCode').textContent = generateVoucherCode();
                    button.onclick = function() {
                        modal.classList.add('hidden');
                        resetGame();
                    };
                    break;
                    
                case 'levelup':
                    title.textContent = "LEVEL UP!";
                    messageEl.textContent = message;
                    button.textContent = "Lanjut ke Level Berikutnya";
                    button.onclick = function() {
                        modal.classList.add('hidden');
                        returnToCharacterSelection();
                    };
                    break;
                    
                case 'retry':
                    title.textContent = "COBA LAGI";
                    messageEl.textContent = message;
                    button.textContent = "Ulangi Level";
                    button.onclick = function() {
                        modal.classList.add('hidden');
                        returnToCharacterSelection();
                    };
                    break;
                    
                case 'gameover':
                    title.textContent = "GAME OVER";
                    messageEl.textContent = message;
                    button.textContent = "Main Lagi";
                    button.onclick = function() {
                        modal.classList.add('hidden');
                        resetGame();
                    };
                    break;
                    
                case 'escape':
                    title.textContent = "MUNDUR";
                    messageEl.textContent = message;
                    button.textContent = "Kembali ke Selection";
                    button.onclick = function() {
                        modal.classList.add('hidden');
                        returnToCharacterSelection();
                    };
                    break;
            }
            
            modal.classList.remove('hidden');
        }

        function generateVoucherCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        // NAVIGATION FUNCTIONS
        function returnToCharacterSelection() {
            document.getElementById('battleArena').classList.add('hidden');
            document.getElementById('characterSelection').classList.remove('hidden');
            document.getElementById('battleLog').innerHTML = '';
            updateUI();
        }

        function resetGame() {
            gameState = {
                currentLevel: 1,
                currentLives: 3,
                selectedCharacters: [],
                battleInProgress: false,
                playerTeam: [],
                enemyTeam: []
            };
            localStorage.removeItem('patrionGameProgress');
            returnToCharacterSelection();
            renderCharacterSelection();
            updateUI();
        }

        // SAVE/LOAD PROGRESS
        function saveGameProgress() {
            const progress = {
                level: gameState.currentLevel,
                lives: gameState.currentLives,
                selectedChars: gameState.selectedCharacters
            };
            localStorage.setItem('patrionGameProgress', JSON.stringify(progress));
        }

        function loadGameProgress() {
            const saved = localStorage.getItem('patrionGameProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                gameState.currentLevel = progress.level;
                gameState.currentLives = progress.lives;
                gameState.selectedCharacters = progress.selectedChars || [];
                
                if (gameState.currentLives <= 0) {
                    resetGame(); // Reset if loaded with no lives
                }
            }
        }

        // INITIALIZE GAME ON LOAD
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>